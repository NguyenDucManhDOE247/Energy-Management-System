<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Analysis - EMS</title>
    <link rel="icon" href="/ico/favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="/ico/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" sizes="57x57" href="/ico/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/ico/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/ico/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/ico/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/ico/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/ico/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/ico/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/ico/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/ico/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/ico/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/ico/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="/ico/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/ico/favicon-16x16.png">
    <link rel="manifest" href="/ico/manifest.json">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/ico/ms-icon-144x144.png">
    <meta name="theme-color" content="#ffffff">
    <link rel="stylesheet" href="/assets/css/bootstrap.min.css">
    <link rel="stylesheet" href="/assets/css/styles.css">
    <link rel="stylesheet" href="/assets/fontawesome/css/all.min.css">
</head>
<body>
    <!-- Navbar -->
    <%- include('../components/navbar/navbar.php') %>

    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2>
                        <i class="fas fa-chart-line"></i> 
                        Data Analysis 
                        <% if (timeframe === 'daily') { %>
                            Daily
                        <% } else if (timeframe === 'weekly') { %>
                            Weekly
                        <% } else if (timeframe === 'monthly') { %>
                            Monthly
                        <% } else if (timeframe === 'yearly') { %>
                            Yearly
                        <% } %>
                    </h2>
                </div>

                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Filters</h5>
                    </div>
                    <div class="card-body">
                        <form action="/analytics/<%= timeframe %>" method="get" class="row g-3">
                            <div class="col-md-3">
                                <label for="device_id" class="form-label">Device</label>
                                <select name="device_id" id="device_id" class="form-select">
                                    <option value="">All devices</option>
                                    <% devices.forEach(device => { %>
                                        <option value="<%= device.id %>" <%= device_id === device.id ? 'selected' : '' %>><%= device.name %></option>
                                    <% }); %>
                                </select>
                            </div>
                            
                            <div class="col-md-3">
                                <label for="from" class="form-label">From date</label>
                                <input type="date" class="form-control" id="from" name="from" value="<%= from %>">
                            </div>
                            
                            <div class="col-md-3">
                                <label for="to" class="form-label">To date</label>
                                <input type="date" class="form-control" id="to" name="to" value="<%= to %>">
                            </div>
                            
                            <div class="col-md-3 d-flex align-items-end">
                                <button type="submit" class="btn btn-primary w-100">
                                    <i class="fas fa-search"></i> Filter data
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header d-flex justify-content-between bg-primary text-white">
                        <h5 class="mb-0">
                            Analysis Results
                            <% if (device_id) { %>
                                <% const selectedDevice = devices.find(d => d.id === device_id); %>
                                <% if (selectedDevice) { %>
                                    - <%= selectedDevice.name %>
                                <% } %>
                            <% } %>
                        </h5>
                        <div class="btn-group">
                            <a href="/analytics/daily<%= device_id ? '?device_id=' + device_id : '' %>" class="btn btn-sm <%= timeframe === 'daily' ? 'btn-light' : 'btn-outline-light' %>">Day</a>
                            <a href="/analytics/weekly<%= device_id ? '?device_id=' + device_id : '' %>" class="btn btn-sm <%= timeframe === 'weekly' ? 'btn-light' : 'btn-outline-light' %>">Week</a>
                            <a href="/analytics/monthly<%= device_id ? '?device_id=' + device_id : '' %>" class="btn btn-sm <%= timeframe === 'monthly' ? 'btn-light' : 'btn-outline-light' %>">Month</a>
                            <a href="/analytics/yearly<%= device_id ? '?device_id=' + device_id : '' %>" class="btn btn-sm <%= timeframe === 'yearly' ? 'btn-light' : 'btn-outline-light' %>">Year</a>
                        </div>
                    </div>
                    <div class="card-body">
                        <% if (analyticsData && analyticsData.length > 0) { %>
                            <div class="row mb-4">
                                <div class="col-12">
                                    <div id="consumption-chart" style="height: 400px;"></div>
                                </div>
                            </div>
                            
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead>
                                        <tr>
                                            <th>
                                                <% if (timeframe === 'daily') { %>
                                                    Day
                                                <% } else if (timeframe === 'weekly') { %>
                                                    Week
                                                <% } else if (timeframe === 'monthly') { %>
                                                    Month
                                                <% } else if (timeframe === 'yearly') { %>
                                                    Year
                                                <% } %>
                                            </th>
                                            <th>Total Consumption (kWh)</th>
                                            <th>Average Consumption</th>
                                            <th>Estimated Cost (VND)</th>
                                            <% if (timeframe === 'daily') { %>
                                                <th>Maximum Power (W)</th>
                                            <% } %>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% analyticsData.forEach(item => { %>
                                            <tr>
                                                <td>
                                                    <% if (timeframe === 'daily') { %>
                                                        <%= new Date(item.date).toLocaleDateString('en-US') %>
                                                    <% } else if (timeframe === 'weekly') { %>
                                                        <%= item.week %> 
                                                        (<%= new Date(item.startDate).toLocaleDateString('en-US') %> - 
                                                        <%= new Date(item.endDate).toLocaleDateString('en-US') %>)
                                                    <% } else if (timeframe === 'monthly') { %>
                                                        <%= item.month %>/<%= item.year %>
                                                    <% } else if (timeframe === 'yearly') { %>
                                                        <%= item.year %>
                                                    <% } %>
                                                </td>
                                                <td><%= item.totalConsumption.toFixed(2) %> kWh</td>
                                                <td>
                                                    <% if (timeframe === 'daily') { %>
                                                        N/A
                                                    <% } else if (timeframe === 'weekly') { %>
                                                        <%= item.averageDailyConsumption.toFixed(2) %> kWh/day
                                                    <% } else if (timeframe === 'monthly') { %>
                                                        <%= item.averageDailyConsumption.toFixed(2) %> kWh/day
                                                    <% } else if (timeframe === 'yearly') { %>
                                                        <%= item.averageMonthlyConsumption.toFixed(2) %> kWh/month
                                                    <% } %>
                                                </td>
                                                <td><%= Math.round(item.costEstimate * 3000) %> VND</td>
                                                <% if (timeframe === 'daily') { %>
                                                    <td><%= item.peakDemand.toFixed(2) %> W</td>
                                                <% } %>
                                            </tr>
                                        <% }); %>
                                    </tbody>
                                </table>
                            </div>
                        <% } else { %>
                            <div class="alert alert-info">
                                No analysis data matches the selected criteria.
                            </div>
                        <% } %>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="/assets/js/jquery.min.js"></script>
    <script src="/assets/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        $(document).ready(function() {
            <% if (analyticsData && analyticsData.length > 0) { %>
                // Chart data
                const chartData = {
                    labels: [
                        <% analyticsData.forEach((item, index) => { %>
                            <% if (timeframe === 'daily') { %>
                                '<%= new Date(item.date).toLocaleDateString('en-US') %>'<%= index < analyticsData.length - 1 ? ',' : '' %>
                            <% } else if (timeframe === 'weekly') { %>
                                '<%= item.week %>'<%= index < analyticsData.length - 1 ? ',' : '' %>
                            <% } else if (timeframe === 'monthly') { %>
                                '<%= item.month %>/<%= item.year %>'<%= index < analyticsData.length - 1 ? ',' : '' %>
                            <% } else if (timeframe === 'yearly') { %>
                                '<%= item.year %>'<%= index < analyticsData.length - 1 ? ',' : '' %>
                            <% } %>
                        <% }); %>
                    ],
                    datasets: [{
                        label: 'Electricity Consumption (kWh)',
                        data: [<%= analyticsData.map(item => item.totalConsumption.toFixed(2)).join(',') %>],
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                };

                // Create chart
                const ctx = document.getElementById('consumption-chart').getContext('2d');
                new Chart(ctx, {
                    type: 'bar',
                    data: chartData,
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'kWh'
                                }
                            }
                        },
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
            <% } %>
        });
    </script>
</body>
</html>
